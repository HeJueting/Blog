# 编译器和解释器：V8 是如何执行一段 JavaScript 代码的？

</br>

### 解释器和编译器

之所以存在解释器和编译器，是因为机器不能直接理解我们所写的代码，我们需要利用编译器和解释器将我们所写的代码“翻译”成机器能读懂的机器语言

1. 解释器：解释型语言每次运行时都需要通过解释器对程序进行动态解释和执行（例如 JavaScript/Python）

2. 编译器：在编译型语言在程序执行之前，需要经过编译器的编译过程，并且编译之后会直接保留机器能读懂的二进制文件，这样每次运行程序时，都可以直接运行该二进制文件，而不需要再次重新编译了（例如 C/C++）

</br>
</br>

### V8 是如何执行一段 JavaScript 代码的

在 V8 在执行过程中既有解释器 Ignition，又有编译器 TurboFan

</br>

#### 1、生成抽象语法树（AST）和执行上下文

高级语言是开发者可以理解的语言，但是让编译器或者解释器来理解就非常困难，因此 V8 会先将源代码转换为抽象语法树，并生成执行上下文（此过程类似于浏览器将 HTML 文件解析为 DOM 树），生成 AST 需要经过两个阶段：

1. 词法分析：将一行行的源码拆解成一个个 token（指的是语法上不可能再分的、最小的单个字符或字符串）

2. 语法分析：将上一步生成的 token 数据，根据语法规则转为 AST。如果源码不符合语法规则，就会抛出错误

**babel 的工作原理**

1. 先将 ES6 源码转换为 AST

2. 然后再将 ES6 语法的 AST 转换为 ES5 语法的 AST

3. 最后利用 ES5 的 AST 生成 JavaScript 源代码

</br>

#### 2、生成字节码

1. 解释器 Ignition 会根据 AST **生成字节码，并解释执行字节码**

2. 字节码是介于 AST 和机器码之间的一种代码。与特定类型的机器码无关，字节码需要通过解释器将其转换为机器码后才能执行

3. 机器码所占用的空间远远超过了字节码，因此 V8 团队才会引入字节码

</br>

#### 3. 执行代码

1. 解释器 Ignition 除了负责生成字节码之外，它还有另外一个作用，就是解释执行字节码

2. 如果一段代码被重复执行多次，这种就称为**热点代码**，那么后台的**编译器 TurboFan 就会把该段热点的字节码编译为高效的机器码**

</br>
</br>

### 即时编译（JIT）技术

在解释器生成字节码后，不断解释执行字节码的同时，也引入了编译器，对经常执行的字节码进行编译成为机器码，使其执行效率更高，相反，占用内存也越大

</br>
</br>

### JavaScript 性能优化

1. 提升单次脚本的执行速度，避免 JavaScript 的长任务霸占主线程，这样可以使得页面快速响应交互

2. 避免大的内联脚本，因为在解析 HTML 的过程中，解析和编译也会占用主线程

3. 减少 JavaScript 文件的容量，因为更小的文件会提升下载速度，并且占用更低的内存。

</br>
</br>
